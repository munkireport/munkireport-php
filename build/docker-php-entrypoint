#!/bin/bash
set -e

if [ -z "${APP_KEY}" ]; then
  echo "The environment variable APP_KEY was not supplied, you can use the key generated below in your container environment:"
  php please key:generate --show

  echo "Please include the base64 portion, eg: APP_KEY=base64:aabbbcc"
else
  echo "APP_KEY supplied. Not generating an APP_KEY."
fi

echo "Sleeping 2 seconds for MariaDB"  # TODO put a health check in
sleep 2

php please config:debug
php please migrate --force
php please db:seed

if [[ -z "${APP_URL}" || "${APP_URL}" == "http://localhost:8080" ]]; then
  echo "APP_URL not set, or APP_URL set to default (http://localhost:8080). Please fix this otherwise you may be redirected to a nonexistent host"
fi


# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
	set -- apache2-foreground "$@"
fi

exec "$@"

