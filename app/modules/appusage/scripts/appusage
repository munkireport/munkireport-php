#!/bin/bash

# Munki database check

MANAGEDINSTALLDIR=$(defaults read /Library/Preferences/ManagedInstalls.plist ManagedInstallDir)

if [[ -f "${MANAGEDINSTALLDIR}"/application_usage.sqlite ]]; then

/usr/bin/sqlite3 "${MANAGEDINSTALLDIR}"/application_usage.sqlite <<!
.headers off
.mode csv
.output /usr/local/munki/preflight.d/cache/appusage.csv
SELECT event, bundle_id, app_version, app_path, number_times, last_time FROM application_usage;
!

# crankd check
elif [[ -f /private/var/db/application_usage.sqlite ]]; then

    /usr/bin/sqlite3 /private/var/db/application_usage.sqlite <<!
.headers off
.mode csv
.output /usr/local/munki/preflight.d/cache/appusage.csv
SELECT event, bundle_id, app_version, app_path, number_times, last_time FROM application_usage;
!

# No database found
else

    echo "Error: App usage database not found!"

fi
