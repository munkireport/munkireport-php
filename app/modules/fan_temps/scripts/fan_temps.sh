#!/bin/bash

# Create cache dir if it does not exist
DIR=$(dirname $0)
mkdir -p "$DIR/cache"
fan_temps_file="$DIR/cache/fan_temps.xml"

# vvv New line variable vvv # no touchy
nl='
'
# ^^^ New line variable ^^^ # no touchy

# Gather temperature data
TEMPDATA=$(/usr/local/bin/smckit -tudm | perl -pe 's/\e([^\[\]]|\[.*?[a-zA-Z]|\].*?\a)//g' | sed -e 's/Â°C //')
FANLABLE=$(/usr/local/bin/smckit -f |  tr -d '\000' | perl -pe 's/\e([^\[\]]|\[.*?[a-zA-Z]|\].*?\a)//g' | tr -cd '[[:alnum:]]. .\n' | grep -e '\[id ' | sed -e 's/\[id /fanlable/g' -e 's/\]//g' | awk -F\, '{gsub(/[ \t]+$/, "", $1); print $1 ""}')
FANDATA="${TEMPDATA}${nl}${FANLABLE}${nl}$(/usr/local/bin/smckit -f |  tr -d '\000' | perl -pe 's/\e([^\[\]]|\[.*?[a-zA-Z]|\].*?\a)//g' | grep -e 'id 0\|Current:' | sed -e '1,/	Current:  /s/	Current:  /FAN_0 /;t' -e '1,/	Current:  /s/	Current:  /FAN_1 /;t' -e '1,/	Current:  /s/	Current:  /FAN_2 /;t' -e '1,/	Current:  /s/	Current:  /FAN_3 /;t' -e '1,/	Current:  /s/	Current:  /FAN_4 /;t' -e '1,/	Current:  /s/	Current:  /FAN_5 /;t' -e '1,/	Current:  /s/	Current:  /FAN_6 /;t' -e '1,/	Current:  /s/	Current:  /FAN_7 /;t' -e '1,/	Current:  /s/	Current:  /FAN_8 /;t' -e 's/ RPM//g' | awk -F' ' '{printf "%s %s\n", $1, $2}')"

# Delete the old file or plistbuddy will complain :/
rm "$fan_temps_file" 2>/dev/null

# Turn the FANDATA text mess into a pretty XML file for uploading
for TRANSLATE in 'AMBIENT_AIR_0         (TA0P)  ' 'AMBIENT_AIR_1         (TA1P)  ' 'CPU_0_DIODE             (TC0D)  ' 'CPU_0_PROXIMITY         (TC0P)  ' 'CPU_0_HEATSINK         (TC0H)  ' 'ENCLOSURE_BASE_0        (TB0T)  ' 'ENCLOSURE_BASE_1      (TB1T)  ' 'ENCLOSURE_BASE_2      (TB2T)  ' 'ENCLOSURE_BASE_3      (TB3T)  ' 'GPU_0_DIODE           (TG0D)  ' 'GPU_0_PROXIMITY       (TG0P)  ' 'GPU_0_HEATSINK         (TG0H)  ' 'HEATSINK_0            (Th0H)  ' 'HEATSINK_1            (Th1H)  ' 'HEATSINK_2            (Th2H)  ' 'MEM_SLOTS_PROXIMITY   (TM0P)  ' 'MEM_SLOT_0            (TM0S)  ' 'PALM_REST             (Ts0P)  ' 'NORTHBRIDGE_DIODE       (TN0D)  ' 'NORTHBRIDGE_PROXIMITY   (TN0P)  ' 'Disc in ODD:      ' 'THUNDERBOLT_0         (TI0P)  ' 'THUNDERBOLT_1         (TI1P)  ' 'Unknown   (TTF0)  ' 'Unknown   (TNFP)  ' 'Unknown   (TCFP)  ' 'Unknown   (TC0E)  ' 'Unknown   (TC1C)  ' 'Unknown   (TC2C)  ' 'Unknown   (TC3C)  ' 'Unknown   (TC4C)  ' 'Unknown   (TCGC)  ' 'Unknown   (TCSA)  ' 'Unknown   (TCXC)  ' 'Unknown   (TG1D)  ' 'Unknown   (TG1F)  ' 'Unknown   (TG1d)  ' 'Unknown   (TGTC)  ' 'Unknown   (TGTD)  ' 'Unknown   (TPCD)  ' 'Unknown   (Ts1S)  ' 'Unknown   (Tsqf)  ' 'ODD_PROXIMITY           (TO0P)  ' 'NORTHBRIDGE             (TN0H)  ' 'MISC_PROXIMITY          (Tm0P)  ' 'LCD_PROXIMITY           (TL0P)  ' 'CPU_0_DIE             (TC0F)  ' 'FAN_0 ' 'FAN_1 ' 'FAN_2 ' 'FAN_3 ' 'FAN_4 ' 'FAN_5 ' 'FAN_6 ' 'FAN_7 ' 'FAN_8 ' 'fanlable0 ' 'fanlable1 ' 'fanlable2 ' 'fanlable3 ' 'fanlable4 ' 'fanlable5 ' 'fanlable6 ' 'fanlable7 ' 'fanlable8 ' 'Unknown   (TA0p)  ' 'Unknown   (TC0C)  ' 'Unknown   (TG0p)  ' 'Unknown   (TH0O)  ' 'Unknown   (TH1O)  ' 'Unknown   (TL0V)  ' 'Unknown   (TL0p)  ' 'Unknown   (TL1V)  ' 'Unknown   (TL2V)  ' 'Unknown   (TLAV)  ' 'Unknown   (TLBV)  ' 'Unknown   (TLCV)  ' 'Unknown   (TO0p)  ' 'Unknown   (TS0V)  ' 'Unknown   (TS2V)  ' 'Unknown   (Tm0p)  ' 'Unknown   (Tp1P)  ' 'Unknown   (Tp2H)  ' 'Unknown   (Tp3H)  ' 'Unknown   (Tp3v)  ' 'PWR_SUPPLY_PROXIMITY   (Tp0P)  ' 'HDD_PROXIMITY          (TH0P)  ' 'Unknown   (TA1p)  ' 'Unknown   (TC0G)  ' 'Unknown   (TC0J)  ' 'Unknown   (TC0c)  ' 'Unknown   (TC0d)  ' 'Unknown   (TC0p)  ' 'Unknown   (TC1c)  ' 'Unknown   (TC2c)  ' 'Unknown   (TC3c)  ' 'Unknown   (TCGc)  ' 'Unknown   (TCPG)  ' 'Unknown   (TCSC)  ' 'Unknown   (TCSc)  ' 'Unknown   (TCTD)  ' 'Unknown   (TCXc)  ' 'Unknown   (TCXr)  ' 'Unknown   (TH0A)  ' 'Unknown   (TH0B)  ' 'Unknown   (TH0C)  ' 'Unknown   (TH0F)  ' 'Unknown   (TH0X)  ' 'Unknown   (TH0a)  ' 'Unknown   (TH0b)  ' 'Unknown   (TH0c)  ' 'Unknown   (TH1A)  ' 'Unknown   (TH1B)  ' 'Unknown   (TH1C)  ' 'Unknown   (TH1F)  ' 'Unknown   (TH1X)  ' 'Unknown   (TH1a)  ' 'Unknown   (TH1b)  ' 'Unknown   (TH1c)  ' 'Unknown   (TI0p)  ' 'Unknown   (TI1p)  ' 'Unknown   (TM0p)  ' 'Unknown   (TMBS)  ' 'Unknown   (TP0p)  ' 'Unknown   (TW0P)  ' 'Unknown   (TW0p)  ' 'Unknown   (Tp0C)  ' 'Unknown   (Ts0G)  ' 'Unknown   (TBXT)  ' 'Unknown   (TH0R)  ' 'Unknown   (TH0V)  ' 'Unknown   (TH0x)  ' 'Unknown   (THSP)  ' 'Unknown   (TMLB)  ' 'Unknown   (Ts0S)  ' 'Unknown   (Ts1P)  ' 'Unknown   (Ts2S)  ' 'Unknown   (TCAC)  ' 'Unknown   (TCAD)  ' 'Unknown   (TCAG)  ' 'Unknown   (TCAH)  ' 'Unknown   (TCAS)  ' 'Unknown   (TCBC)  ' 'Unknown   (TCBD)  ' 'Unknown   (TCBG)  ' 'Unknown   (TCBH)  ' 'Unknown   (TCBS)  ' 'Unknown   (TH1P)  ' 'Unknown   (TH1V)  ' 'Unknown   (TH2F)  ' 'Unknown   (TH2P)  ' 'Unknown   (TH2V)  ' 'Unknown   (TH3F)  ' 'Unknown   (TH3P)  ' 'Unknown   (TH3V)  ' 'Unknown   (TH4F)  ' 'Unknown   (TH4P)  ' 'Unknown   (TH4V)  ' 'Unknown   (THPS)  ' 'Unknown   (THTG)  ' 'Unknown   (TM1P)  ' 'Unknown   (TM2P)  ' 'Unknown   (TM3P)  ' 'Unknown   (TM4P)  ' 'Unknown   (TM5P)  ' 'Unknown   (TM6P)  ' 'Unknown   (TM7P)  ' 'Unknown   (TM8P)  ' 'Unknown   (TMA1)  ' 'Unknown   (TMA2)  ' 'Unknown   (TMA3)  ' 'Unknown   (TMA4)  ' 'Unknown   (TMB1)  ' 'Unknown   (TMB2)  ' 'Unknown   (TMB3)  ' 'Unknown   (TMB4)  ' 'Unknown   (TMHS)  ' 'Unknown   (TMLS)  ' 'Unknown   (TMPS)  ' 'Unknown   (TMPV)  ' 'Unknown   (TMTG)  ' 'Unknown   (TNTG)  ' 'Unknown   (Te1F)  ' 'Unknown   (Te1P)  ' 'Unknown   (Te1S)  ' 'Unknown   (Te2F)  ' 'Unknown   (Te2S)  ' 'Unknown   (Te3F)  ' 'Unknown   (Te3S)  ' 'Unknown   (Te4F)  ' 'Unknown   (Te4S)  ' 'Unknown   (Te5S)  ' 'Unknown   (Te5F)  ' 'Unknown   (TeGG)  ' 'Unknown   (TeGP)  ' 'Unknown   (TeRG)  ' 'Unknown   (TeRP)  ' 'Unknown   (Tp1C)  ' 'Unknown   (TpPS)  ' 'Unknown   (TpTG)  ' 'Unknown   (TA0S)  ' 'Unknown   (TA1S)  ' 'Unknown   (TA2S)  ' 'Unknown   (TA3S)  ' 'Unknown   (Tb0P)  ' 'Unknown   (TC0F)  ' 'Unknown   (TC0H)  ' 'Unknown   (TC0J)  ' 'Unknown   (TC1D)  ' 'Unknown   (TC1E)  ' 'Unknown   (TC1F)  ' 'Unknown   (TC1H)  ' 'Unknown   (TC1P)  ' 'Unknown   (TC5C)  ' 'Unknown   (TC6C)  ' 'Unknown   (TC7C)  ' 'Unknown   (TC8C)  ' 'Unknown   (TCHP)  ' 'Unknown   (TG1H)  ' 'Unknown   (TM1S)  ' 'Unknown   (TM8S)  ' 'Unknown   (TM9P)  ' 'Unknown   (TM9S)  ' 'Unknown   (TN0C)  ' 'Unknown   (TN1P)  ' 'Unknown   (TP0D)  ' 'Unknown   (Tp2P)  ' 'Unknown   (Tp3P)  ' 'Unknown   (Tp4P)  ' 'Unknown   (Tp5P)  ' 'Unknown   (TS0C)  '
do 
	OUTVALUE=$(grep -e "${TRANSLATE}" <<< "${FANDATA}" | sed -e "s/${TRANSLATE}//g" )
    OUTKEY=$(awk -F' ' '{printf "%s%s\n", $1, $2}' <<< "${TRANSLATE}" | sed -e 's/Unknown//g' | tr -cd '[[:alnum:]]' )
    /usr/libexec/plistbuddy -c "add :${OUTKEY} string ${OUTVALUE}" "$fan_temps_file" 1>/dev/null
done

exit 0